<!-- Tile 1: fetch sheet & draw chart (akses-style) -->
<script>
(function(){
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS9NxgDwQDoJrQZJS4apFq-p5oyK3B0WAnFTlCY2WGcvsMzNBGIZjilIez1AXWvAIZgKltIxLEPTFT/pub?gid=1190173258&single=true&output=csv';

  // Views (you can switch with the pills above the chart)
  const views = [
    {id:'bilangan',  label:'Bilangan',           kind:'count'},
    {id:'enrol',     label:'Enrolmen',          kind:'count'},
    {id:'liputan',   label:'Liputan (%)',       kind:'pct_inst'},
    {id:'liputanM',  label:'Liputan Murid (%)', kind:'pct_murid'},
    {id:'tpr',       label:'TPR (%)',           kind:'pct_other'},
    {id:'mbk',       label:'MBK (%)',           kind:'pct_other'},
    {id:'selesai',   label:'Kes Selesai (%)',   kind:'pct_other'},
  ];

  const labels = ["Kota Setar","Pendang","Kuala Muda","Sik","Kulim","Bandar Baru","Kubang Pasu","Pdg Terap","Baling","Yan","Langkawi","Kedah"];

  // Cell maps (A=Pra sekolah di sekolah, B=Tadika kerajaan, C=Tadika swasta)
  const coords = {
    bilangan: {
      A:['D5','E5','F5','G5','H5','I5','J5','K5','L5','M5','N5','O5'],
      B:['D6','E6','F6','G6','H6','I6','J6','K6','L6','M6','N6','O6'],
      C:['D7','E7','F7','G7','H7','I7','J7','K7','L7','M7','N7','O7']
    },
    enrol: {
      A:['D8','E8','F8','G8','H8','I8','J8','K8','L8','M8','N8','O8'],
      B:['D9','E9','F9','G9','H9','I9','J9','K9','L9','M9','N9','O9'],
      C:['D10','E10','F10','G10','H10','I10','J10','K10','L10','M10','N10','O10']
    },
    liputan: {
      A:['D14','E14','F14','G14','H14','I14','J14','K14','L14','M14','N14','O14'],
      B:['D17','E17','F17','G17','H17','I17','J17','K17','L17','M17','N17','O17'],
      C:['D20','E20','F20','G20','H20','I20','J20','K20','L20','M20','N20','O20']
    },
    liputanM: {
      A:['D24','E24','F24','G24','H24','I24','J24','K24','L24','M24','N24','O24'],
      B:['D27','E27','F27','G27','H27','I27','J27','K27','L27','M27','N27','O27'],
      C:['D30','E30','F30','G30','H30','I30','J30','K30','L30','M30','N30','O30']
    },
    tpr: {
      A:['D34','E34','F34','G34','H34','I34','J34','K34','L34','M34','N34','O34'],
      B:['D37','E37','F37','G37','H37','I37','J37','K37','L37','M37','N37','O37'],
      C:['D40','E40','F40','G40','H40','I40','J40','K40','L40','M40','N40','O40']
    },
    mbk: {
      A:['D44','E44','F44','G44','H44','I44','J44','K44','L44','M44','N44','O44'],
      B:['D47','E47','F47','G47','H47','I47','J47','K47','L47','M47','N47','O47'],
      C:['D50','E50','F50','G50','H50','I50','J50','K50','L50','M50','N50','O50']
    },
    selesai: {
      A:['D54','E54','F54','G54','H54','I54','J54','K54','L54','M54','N54','O54'],
      B:['D57','E57','F57','G57','H57','I57','J57','K57','L57','M57','N57','O57'],
      C:['D61','E61','F61','G61','H61','I61','J61','K61','L61','M61','N61','O61']
    }
  };

  // Sasaran lines (shown only for % views)
  const targets = [
    {value:10,  label:'% Pesakit baru warga emas mengikut populasi'},
    {value:100, label:'% Bilangan institusi dilawati di daerah'},
    {value:75,  label:'% Warga Emas disaring'},
    {value:80,  label:'% Rehabilitasi fungsi Warga Emas'},
    {value:30,  label:'% Warga emas â‰¥20 batang gigi'}
  ];

  const catNames = ['Pra sekolah di sekolah','Tadika kerajaan','Tadika swasta'];
  const palette  = ['#0ea5e9','#22c55e','#a78bfa'];

  // ---------- helpers ----------
  function colIndex(A){
    let idx = 0; for (let i=0;i<A.length;i++) idx = idx*26 + (A.charCodeAt(i)-64);
    return idx-1;
  }
  function rawCell(table, A1){
    const m = /^([A-Z]+)(\d+)$/.exec(A1); if(!m) return null;
    const r = +m[2]-1, c = colIndex(m[1]);
    return table[r] && table[r][c]!=null ? table[r][c] : null;
  }
  const toNum = (v)=> Number(String(v).replace(/\u00A0/g,'').replace(/[, ]/g,'').replace(/%/g,'').trim()) || 0;
  function seriesFrom(table, arrA1){ return arrA1.map(a1 => toNum(rawCell(table,a1))); }

  function buildSeries(table, viewKey){
    const map = coords[viewKey];
    return [
      seriesFrom(table, map.A),
      seriesFrom(table, map.B),
      seriesFrom(table, map.C)
    ];
  }

  function makeTargetDataset(value,label,count){
    return {
      type:'line',
      label:`Sasaran: ${label}`,
      data:new Array(count).fill(value),
      borderColor:'rgba(15,27,45,0.25)',
      borderDash:[6,6],
      pointRadius:0,
      borderWidth:1.5,
      tension:0
    };
  }

  // View switcher pills
  function renderViewTags(active){
    const wrap = document.getElementById('s1views');
    wrap.innerHTML = '';
    views.forEach(v=>{
      const b = document.createElement('button');
      b.className = 'pill' + (v.id===active?' active':'');
      b.textContent = v.label;
      b.dataset.view = v.id;
      b.onclick = ()=>{ draw(v.id); wrap.querySelectorAll('.pill').forEach(p=>p.classList.remove('active')); b.classList.add('active'); };
      wrap.appendChild(b);
    });
  }

  // -------- akses-like chart styling --------
  let CHART;
  function draw(viewId){
    if(!window.__table) return;

    const [A,B,C] = buildSeries(window.__table, viewId);
    const isPct = ['liputan','liputanM','tpr','mbk','selesai'].includes(viewId);

    const ctx = document.getElementById('s1').getContext('2d');

    // soft gradients like akses
    function grad(hex){
      const g = ctx.createLinearGradient(0,0,0,260);
      const rgb = hex; // pass hex directly to rgba()
      g.addColorStop(0, hexToRgba(rgb, .35));
      g.addColorStop(1, hexToRgba(rgb, .03));
      return g;
    }
    function hexToRgba(h,a){
      const c = parseInt(h.slice(1),16);
      const r = (c>>16)&255, g=(c>>8)&255, b=c&255;
      return `rgba(${r},${g},${b},${a})`;
    }

    const datasets = [
      {
        type:'line', label:catNames[0], data:A,
        borderColor:palette[0], backgroundColor:grad(palette[0]),
        borderWidth:3, tension:.45, fill:true,
        pointRadius:(c)=> (c.dataIndex===0 || c.dataIndex===labels.length-1)?0:3
      },
      {
        type:'line', label:catNames[1], data:B,
        borderColor:palette[1], backgroundColor:grad(palette[1]),
        borderWidth:3, tension:.45, fill:true,
        pointRadius:(c)=> (c.dataIndex===0 || c.dataIndex===labels.length-1)?0:3
      },
      {
        type:'line', label:catNames[2], data:C,
        borderColor:palette[2], backgroundColor:grad(palette[2]),
        borderWidth:3, tension:.45, fill:true,
        pointRadius:(c)=> (c.dataIndex===0 || c.dataIndex===labels.length-1)?0:3
      }
    ];

    if(isPct){ targets.forEach(t=> datasets.push(makeTargetDataset(t.value,t.label,labels.length))); }

    const cfg = {
      type:'line',
      data:{ labels, datasets },
      options:{
        responsive:true,
        aspectRatio: 16/7,
        layout:{ padding:{ top:8, right:8, bottom:140, left:8 }}, // same extra room for x labels
        plugins:{
          legend:{ position:'bottom' },
          tooltip:{ mode:'index', intersect:false, callbacks:{
            label: (ctx)=> {
              const v = ctx.parsed.y;
              return `${ctx.dataset.label}: ${isPct? v+'%': v.toLocaleString()}`;
            }
          }}
        },
        scales:{
          x:{ ticks:{ autoSkip:false, maxRotation:0, minRotation:0 } },
          y:{ beginAtZero:true, max: isPct?105:undefined,
              ticks:{ callback:(v)=> isPct? v+'%': v.toLocaleString() } }
        }
      }
    };

    if(CHART) CHART.destroy();
    CHART = new Chart(ctx, cfg);
    document.getElementById('s1time').textContent = 'Dikemas kini: '+ new Date().toLocaleString();
  }

  // refresh / expand behave like akses
  document.getElementById('s1refresh')?.addEventListener('click', ()=>{
    const active = document.querySelector('#s1views .pill.active')?.dataset.view || 'liputan';
    draw(active);
  });
  document.getElementById('s1expand')?.addEventListener('click', ()=>{
    const modal = document.getElementById('modal');
    const mctx  = document.getElementById('mcanvas').getContext('2d');
    modal.classList.add('open');
    const active = document.querySelector('#s1views .pill.active')?.dataset.view || 'liputan';
    const [A,B,C] = buildSeries(window.__table, active);
    const isPct = ['liputan','liputanM','tpr','mbk','selesai'].includes(active);

    function grad(hex){
      const g = mctx.createLinearGradient(0,0,0,320);
      const rgb = hex; 
      g.addColorStop(0, hexToRgba(rgb, .35));
      g.addColorStop(1, hexToRgba(rgb, .03));
      return g;
    }
    function hexToRgba(h,a){
      const c = parseInt(h.slice(1),16);
      const r = (c>>16)&255, g=(c>>8)&255, b=c&255;
      return `rgba(${r},${g},${b},${a})`;
    }

    const datasets = [
      { type:'line', label:catNames[0], data:A, borderColor:palette[0], backgroundColor:grad(palette[0]), borderWidth:3, tension:.45, fill:true, pointRadius:2 },
      { type:'line', label:catNames[1], data:B, borderColor:palette[1], backgroundColor:grad(palette[1]), borderWidth:3, tension:.45, fill:true, pointRadius:2 },
      { type:'line', label:catNames[2], data:C, borderColor:palette[2], backgroundColor:grad(palette[2]), borderWidth:3, tension:.45, fill:true, pointRadius:2 }
    ];
    if(isPct){ targets.forEach(t=> datasets.push(makeTargetDataset(t.value,t.label,labels.length))); }

    if(window.__mchart) window.__mchart.destroy();
    window.__mchart = new Chart(mctx, {
      type:'line',
      data:{ labels, datasets },
      options:{
        plugins:{ legend:{ position:'bottom' } },
        scales:{ y:{ beginAtZero:true, max:isPct?105:undefined, ticks:{ callback:(v)=> isPct? v+'%': v.toLocaleString() } } }
      }
    });

    document.getElementById('mclose').onclick = ()=>{ modal.classList.remove('open'); window.__mchart?.destroy(); };
  });

  // Fetch & init
  Papa.parse(CSV_URL, {
    download:true, skipEmptyLines:true,
    complete: (res)=>{
      window.__table = res.data;
      renderViewTags('liputan'); // default to % so sasaran shows
      draw('liputan');
    },
    error: (e)=>{ document.getElementById('s1err').textContent = 'Ralat memuatkan data: ' + e; }
  });
})();
</script>
