<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kesihatan Pergigian Sekolah</title>

  <!-- Prevent favicon 404 -->
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=9">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- SVG sprite (icons) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-time" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/>
    </symbol>
    <symbol id="i-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v6h-6"/>
    </symbol>
    <symbol id="i-expand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 9V4h5M4 4l6 6"/><path d="M20 15v5h-5M20 20l-6-6"/>
      <path d="M15 4h5v5M20 4l-6 6"/><path d="M9 20H4v-5M4 20l6-6"/>
    </symbol>
    <symbol id="i-filter" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 5h18l-7 8v6l-4-2v-4L3 5z"/>
    </symbol>
    <symbol id="i-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M18 6L6 18M6 6l12 12"/>
    </symbol>
    <symbol id="i-back" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M15 18l-6-6 6-6"/><path d="M21 12H9"/>
    </symbol>
    <symbol id="i-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="7"></circle><path d="M21 21l-3.6-3.6"></path>
    </symbol>
    <symbol id="i-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M20 6L9 17l-5-5"/>
    </symbol>
    <symbol id="i-eraser" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M16 3l5 5-10 10H6L1 13l10-10 5 5"/>
    </symbol>
  </svg>
</head>
<body>

  <!-- PAGE HEADER -->
  <header class="ph">
    <h1>Kesihatan Pergigian Sekolah</h1>
    <p>Analisis proses dan sasaran kesihatan pergigian pelajar sekolah negeri Kedah.</p>

    <!-- Search bar row (Back • Input • Search) -->
    <div class="searchbar" role="search">
      <!-- Back (ghost) -->
      <a class="btn btn-ghost" href="index.html" aria-label="Kembali ke halaman utama">
        <svg class="ico" width="20" height="20"><use href="#i-back"/></svg>
      </a>

      <!-- Input -->
      <input id="schoolSearch" type="search"
             placeholder="Cari di halaman ini… (kategori, tajuk graf)"
             autocomplete="off" />
      <div id="gs-suggest" class="gs-suggest" hidden></div>

      <!-- Search (teal) -->
      <button id="schoolSearchRight" type="button" class="btn" aria-label="Cari">
        <svg class="ico" width="20" height="20"><use href="#i-search"/></svg>
        <span class="lbl" hidden>Cari</span>
      </button>
    </div>
  </header>

  <!-- GRID -->
  <main class="grid">

    <!-- ===================================== -->
    <!-- Tile 1 — Pra Sekolah / Tadika (wide) -->
    <!-- ===================================== -->
    <section class="tile wide" id="ps1tile">
      <div class="th">
        <div>
          <h2 class="ttl">Pra Sekolah, Tadika & Tadika Swasta</h2>
          <div class="sub"><svg class="ico"><use href="#i-time"/></svg><span id="ps1time">—</span></div>
        </div>
        <div class="act">
          <!-- Filter -->
          <div class="dd" id="ps1dd">
            <button class="btn dd-trigger" id="ps1filter" title="Tapis">
              <svg class="ico"><use href="#i-filter"/></svg>
            </button>
            <div class="menu" id="ps1menu" style="min-width:320px">
              <div class="menu-body">
                <ul class="cklist" id="ps1list" style="padding:8px 12px 0 12px"></ul>
              </div>
              <div class="mfoot">
                <button class="icbtn" id="ps1apply" title="Terapkan"><svg class="ico"><use href="#i-check"/></svg></button>
                <button class="icbtn" id="ps1reset" title="Kosongkan"><svg class="ico"><use href="#i-eraser"/></svg></button>
                <button class="icbtn" id="ps1close" title="Tutup"><svg class="ico"><use href="#i-x"/></svg></button>
              </div>
            </div>
          </div>
          <!-- Refresh & Expand -->
          <button id="ps1refresh" class="btn" title="Kemas Kini"><svg class="ico"><use href="#i-refresh"/></svg></button>
          <button id="ps1expand" class="btn" title="Perbesar"><svg class="ico"><use href="#i-expand"/></svg></button>
        </div>
      </div>
      <div class="tb">
        <div class="chart"><canvas id="ps1"></canvas></div>
        <div class="legend" id="ps1legend"></div>
        <div class="err" id="ps1err"></div>
      </div>
    </section>

    <!-- ===================================== -->
    <!-- Tile 2 (left on second row) — Sek Ren -->
    <!-- ===================================== -->
    <section class="tile" id="ps2tile">
      <div class="th">
        <div>
          <h2 class="ttl">Sekolah Rendah</h2>
          <div class="sub"><svg class="ico"><use href="#i-time"/></svg><span id="ps2time">—</span></div>
        </div>
        <div class="act">
          <div class="dd" id="ps2dd">
            <button class="btn dd-trigger" id="ps2filter" title="Tapis">
              <svg class="ico"><use href="#i-filter"/></svg>
            </button>
            <div class="menu" id="ps2menu" style="min-width:320px">
              <div class="menu-body">
                <ul class="cklist" id="ps2list" style="padding:8px 12px 0 12px"></ul>
              </div>
              <div class="mfoot">
                <button class="icbtn" id="ps2apply" title="Terapkan"><svg class="ico"><use href="#i-check"/></svg></button>
                <button class="icbtn" id="ps2reset" title="Kosongkan"><svg class="ico"><use href="#i-eraser"/></svg></button>
                <button class="icbtn" id="ps2close" title="Tutup"><svg class="ico"><use href="#i-x"/></svg></button>
              </div>
            </div>
          </div>
          <button id="ps2refresh" class="btn" title="Kemas Kini"><svg class="ico"><use href="#i-refresh"/></svg></button>
          <button id="ps2expand" class="btn" title="Perbesar"><svg class="ico"><use href="#i-expand"/></svg></button>
        </div>
      </div>
      <div class="tb">
        <div class="chart"><canvas id="ps2"></canvas></div>
        <div class="legend" id="ps2legend"></div>
        <div class="err" id="ps2err"></div>
      </div>
    </section>

    <!-- ===================================== -->
    <!-- Tile 3 (right on second row) — kosong -->
    <!-- ===================================== -->
    <section class="tile" id="ps3tile">
      <div class="th">
        <div>
          <h2 class="ttl">Intervensi Sekolah</h2>
          <div class="sub"><svg class="ico"><use href="#i-time"/></svg><span>—</span></div>
        </div>
        <div class="act">
          <button class="btn" title="Kemas Kini"><svg class="ico"><use href="#i-refresh"/></svg></button>
          <button class="btn" title="Perbesar"><svg class="ico"><use href="#i-expand"/></svg></button>
        </div>
      </div>
      <div class="tb">
        <div class="chart" style="min-height:340px;display:grid;place-items:center;color:#9aa3af">—</div>
        <div class="err" id="ps3err"></div>
      </div>
    </section>

  </main>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-inner">
      <div class="mh">
        <h3 id="mtitle" style="margin:0;font-weight:800">Perincian</h3>
        <button class="close" id="mclose">Tutup</button>
      </div>
      <div class="mb"><div class="mchart"><canvas id="mcanvas"></canvas></div></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="wrap">
    <div class="content">© Kedah Oral Health Analytics • Data Kesihatan Pergigian yang disahkan dan dikemas kini.</div>
  </footer>

  <!-- ================= Scripts (Tile 1 + Tile 2) ================= -->
  <script>
  // Common helpers
  const LABELS_DO = ['Kota Setar','Pendang','Kuala Muda','Sik','Kulim','Bandar Baru','Kubang Pasu','Pdg Terap','Baling','Yan','Langkawi','Kedah'];
  const COLS_DO   = ['D','E','F','G','H','I','J','K','L','M','N','O'];
  const colIdx = L => L.toUpperCase().charCodeAt(0)-65;
  const num = v => { if(v==null) return 0; const n=parseFloat(String(v).replace(/[, ]/g,'')); return isNaN(n)?0:n; };
  const nowMY = ()=> new Date().toLocaleString('ms-MY',{hour12:false});

  /* ==========================================================
     TILE 1 — PRA SEKOLAH, TADIKA & TADIKA SWASTA (Dual axis)
     ========================================================== */
  const PS1_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS9NxgDwQDoJrQZJS4apFq-p5oyK3B0WAnFTlCY2WGcvsMzNBGIZjilIez1AXWvAIZgKltIxLEPTFT/pub?gid=1190173258&single=true&output=csv';

  // Filter list (as requested)
  const PS1_FILTERS = [
    { key:'inst',     label:'Bilangan institusi', axis:'y2' },
    { key:'enrol',    label:'Enrolmen murid',     axis:'y2' },
    { key:'lipTadika',label:'% Liputan Tadika',   axis:'y'  },
    { key:'lipMurid', label:'% Liputan Murid',    axis:'y'  },
    { key:'tpr',      label:'% TPR',              axis:'y'  },
    { key:'mbk',      label:'% MBK',              axis:'y'  },
    { key:'selesai',  label:'% Kes selesai',      axis:'y'  },
  ];

  // Sasaran (tile 1)
  const PS1_TARGETS = [
    { label:'Sasaran: % Liputan Tadika — 100%', value:100 },
    { label:'Sasaran: % Liputan Murid — 80%',   value:80  },
    { label:'Sasaran: % TPR — 70%',             value:70  },
    { label:'Sasaran: % Pesakit MBK — 50%',     value:50  },
    { label:'Sasaran: Kes Selesai Pra Sekolah & Tadika Kerajaan — 70%', value:70 },
  ];

  let chartPS1=null;
  const ps1State = { active:new Set(PS1_FILTERS.map(f=>f.key)), series:null };

  (function buildPS1FilterUI(){
    const ul = document.getElementById('ps1list');
    PS1_FILTERS.forEach(f=>{
      const li = document.createElement('li');
      li.style.listStyle='none'; li.style.padding='6px 6px';
      li.innerHTML = `
        <label class="ckrow" style="display:flex;align-items:center;gap:.75rem;cursor:pointer;">
          <input type="checkbox" data-key="${f.key}" checked/>
          <span>${f.label}</span>
        </label>`;
      ul.appendChild(li);
    });

    const menu = document.getElementById('ps1menu');
    document.getElementById('ps1filter').onclick = ()=> menu.classList.add('open');
    document.getElementById('ps1close').onclick  = ()=> menu.classList.remove('open');
    document.getElementById('ps1apply').onclick  = ()=>{
      ps1State.active.clear();
      ul.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) ps1State.active.add(cb.dataset.key); });
      menu.classList.remove('open'); drawPS1();
    };
    document.getElementById('ps1reset').onclick  = ()=>{
      ul.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
      ps1State.active.clear(); drawPS1();
    };
  })();

  async function loadPS1(){
    const csv = await (await fetch(PS1_CSV)).text();
    const rows = Papa.parse(csv).data;

    const rowVals=(r)=> COLS_DO.map(c=> num(rows[r-1]?.[colIdx(c)]));

    // Line graph 1..3  : Bilangan institusi
    const instPra   = rowVals(5);
    const instKer   = rowVals(6);
    const instSwa   = rowVals(7);
    // Line graph 4..6  : Enrolmen murid
    const enrPra    = rowVals(8);
    const enrKer    = rowVals(9);
    const enrSwa    = rowVals(10);
    // Line graph 7..9  : % liputan tadika
    const lipTanPra = rowVals(14);
    const lipTanKer = rowVals(17);
    const lipTanSwa = rowVals(20);
    // Line graph 10..12: % liputan murid
    const lipMurPra = rowVals(24);
    const lipMurKer = rowVals(27);
    const lipMurSwa = rowVals(30);
    // Line graph 13..15: % TPR
    const tprPra    = rowVals(34);
    const tprKer    = rowVals(37);
    const tprSwa    = rowVals(40);
    // Line graph 16..18: % MBK
    const mbkPra    = rowVals(44);
    const mbkKer    = rowVals(47);
    const mbkSwa    = rowVals(50);
    // Line graph 19..21: % Kes selesai
    const selPra    = rowVals(54);
    const selKer    = rowVals(57);
    const selSwa    = rowVals(61);

    // combine by category
    ps1State.series = {
      inst:  LABELS_DO.map((_,i)=> instPra[i]+instKer[i]+instSwa[i]),
      enrol: LABELS_DO.map((_,i)=> enrPra[i]+enrKer[i]+enrSwa[i]),
      lipTadika: LABELS_DO.map((_,i)=> (lipTanPra[i]+lipTanKer[i]+lipTanSwa[i])/3 ),
      lipMurid:  LABELS_DO.map((_,i)=> (lipMurPra[i]+lipMurKer[i]+lipMurSwa[i])/3 ),
      tpr:       LABELS_DO.map((_,i)=> (tprPra[i]+tprKer[i]+tprSwa[i])/3 ),
      mbk:       LABELS_DO.map((_,i)=> (mbkPra[i]+mbkKer[i]+mbkSwa[i])/3 ),
      selesai:   LABELS_DO.map((_,i)=> (selPra[i]+selKer[i]+selSwa[i])/3 ),
    };

    document.getElementById('ps1time').textContent = nowMY();
  }

  function ps1Datasets(){
    const colors = {
      inst:{border:'#0ea5e9',bg:'rgba(14,165,233,.12)'},
      enrol:{border:'#22c55e',bg:'rgba(34,197,94,.12)'},
      lipTadika:{border:'#38bdf8',bg:'rgba(56,189,248,.10)'},
      lipMurid:{border:'#60a5fa',bg:'rgba(96,165,250,.10)'},
      tpr:{border:'#e879f9',bg:'rgba(232,121,249,.10)'},
      mbk:{border:'#a78bfa',bg:'rgba(167,139,250,.10)'},
      selesai:{border:'#f59e0b',bg:'rgba(245,158,11,.10)'},
      target:'#9ca3af'
    };
    const def=(lbl,dat,col,ax)=>({type:'line',label:lbl,data:dat,yAxisID:ax,borderColor:col.border,backgroundColor:col.bg,tension:.35,fill:true,pointRadius:4,pointHoverRadius:5,borderWidth:2});
    const ds=[];
    PS1_FILTERS.forEach(f=>{ if(ps1State.active.has(f.key)) ds.push(def(f.label, ps1State.series[f.key], colors[f.key], f.axis)); });
    PS1_TARGETS.forEach(t=>{
      ds.push({type:'line',label:t.label,data:Array(LABELS_DO.length).fill(t.value),yAxisID:'y',borderColor:colors.target,borderDash:[6,6],borderWidth:2,pointRadius:0,fill:false});
    });
    return ds;
  }

  function drawPS1(inModal=false){
    const ctx=(inModal?document.getElementById('mcanvas'):document.getElementById('ps1')).getContext('2d');
    if(!inModal && chartPS1) chartPS1.destroy();
    if(inModal && window.__mchart) window.__mchart.destroy();

    const obj=new Chart(ctx,{
      type:'line',
      data:{labels:LABELS_DO,datasets:ps1Datasets()},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false,callbacks:{label:(c)=>` ${c.dataset.label}: ${c.dataset.yAxisID==='y'? c.parsed.y.toFixed(0)+'%': c.parsed.y.toLocaleString()} `}}},
        scales:{
          y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'},grid:{color:'rgba(156,163,175,.35)',borderDash:[4,4]}},
          y2:{position:'right',beginAtZero:true,grid:{drawOnChartArea:false},ticks:{callback:v=>v.toLocaleString()}},
          x:{ticks:{autoSkip:false,maxRotation:(window.innerWidth<640?90:0),minRotation:(window.innerWidth<640?90:0)}}
        }
      }
    });
    if(inModal) window.__mchart=obj; else chartPS1=obj;
  }

  async function loadDataAndDraw(){
    try{ await loadPS1(); drawPS1(false); }catch(e){ console.error(e); document.getElementById('ps1err').textContent='Ralat memuat data.'; }
  }

  document.getElementById('ps1refresh').addEventListener('click', loadDataAndDraw);
  document.getElementById('ps1expand').addEventListener('click', ()=>{
    document.getElementById('mtitle').textContent='Pra Sekolah, Tadika & Tadika Swasta';
    const modal=document.getElementById('modal'); modal.classList.add('open');
    drawPS1(true);
    document.getElementById('mclose').onclick=()=>{ modal.classList.remove('open'); window.__mchart?.destroy(); };
  });

  // kick off tile 1
  loadDataAndDraw();

  /* ============================================
     TILE 2 — SEKOLAH RENDAH (Dual axis + filter)
     ============================================ */
  const PS2_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSS9NxgDwQDoJrQZJS4apFq-p5oyK3B0WAnFTlCY2WGcvsMzNBGIZjilIez1AXWvAIZgKltIxLEPTFT/pub?gid=282265418&single=true&output=csv';

  const PS2_FILTERS = [
    { key:'sekolah',   label:'Bilangan sekolah', axis:'y2' },
    { key:'enrol',     label:'Jumlah enrolmen',  axis:'y2' },
    { key:'srDilawati',label:'Peratus SR dilawati', axis:'y' },
    { key:'liputan',   label:'Peratus murid SR mendapat liputan', axis:'y' },
    { key:'orallyFit', label:'Peratus murid SR mencapai status orally fit', axis:'y' },
    { key:'kesSelesai',label:'Peratus murid SR kes selesai', axis:'y' },
    { key:'tpr',       label:'Peratus murid SR TPR', axis:'y' }
  ];

  const PS2_TARGETS = [
    { label:'Sasaran: % SR dilawati — 100%', value:100 },
    { label:'Sasaran: % Murid SR mendapat liputan — 96%', value:96 },
    { label:'Sasaran: % Murid SR mencapai status orally fit — 95%', value:95 },
    { label:'Sasaran: % Liputan murid SR mencapai status orally fit kes selesai — 95%', value:95 },
    { label:'Sasaran: % Murid SR maintaining orally fit (TPR) — 65%', value:65 },
  ];

  let chartPS2=null;
  const ps2State = { active:new Set(PS2_FILTERS.map(f=>f.key)), series:null };

  (function buildPS2FilterUI(){
    const ul=document.getElementById('ps2list');
    PS2_FILTERS.forEach(f=>{
      const li=document.createElement('li'); li.style.listStyle='none'; li.style.padding='6px 6px';
      li.innerHTML = `
        <label class="ckrow" style="display:flex;align-items:center;gap:.75rem;cursor:pointer;">
          <input type="checkbox" data-key="${f.key}" checked/>
          <span>${f.label}</span>
        </label>`;
      ul.appendChild(li);
    });
    const menu=document.getElementById('ps2menu');
    document.getElementById('ps2filter').onclick=()=>menu.classList.add('open');
    document.getElementById('ps2close').onclick =()=>menu.classList.remove('open');
    document.getElementById('ps2apply').onclick =()=>{
      ps2State.active.clear();
      ul.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ if(cb.checked) ps2State.active.add(cb.dataset.key); });
      menu.classList.remove('open'); drawPS2(false);
    };
    document.getElementById('ps2reset').onclick =()=>{
      ul.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
      ps2State.active.clear(); drawPS2(false);
    };
  })();

  async function loadPS2(){
    const csv = await (await fetch(PS2_CSV)).text();
    const rows = Papa.parse(csv).data;
    const rowVals=(r)=> COLS_DO.map(c=> num(rows[r-1]?.[colIdx(c)]));

    // Bilangan sekolah
    const srKer = rowVals(14), srSwa=rowVals(15), srJumlah=rowVals(16);
    // Enrolmen
    const enKer = rowVals(17), enSwa=rowVals(18), enJumlah=rowVals(19);
    // % SR dilawati
    const srDilawati=rowVals(22);
    // % liputan murid
    const liputan=rowVals(25);
    // % orally fit
    const orallyFit=rowVals(28);
    // % kes selesai
    const kesSelesai=rowVals(31);
    // % TPR
    const tpr=rowVals(34);

    ps2State.series = {
      sekolah: srJumlah,
      enrol:   enJumlah,
      srDilawati, liputan, orallyFit, kesSelesai, tpr
    };
    document.getElementById('ps2time').textContent = nowMY();
  }

  function ps2Datasets(){
    const colors={
      sekolah:{border:'#0ea5e9',bg:'rgba(14,165,233,.12)'},
      enrol:{border:'#22c55e',bg:'rgba(34,197,94,.12)'},
      srDilawati:{border:'#38bdf8',bg:'rgba(56,189,248,.10)'},
      liputan:{border:'#60a5fa',bg:'rgba(96,165,250,.10)'},
      orallyFit:{border:'#a78bfa',bg:'rgba(167,139,250,.10)'},
      kesSelesai:{border:'#f59e0b',bg:'rgba(245,158,11,.10)'},
      tpr:{border:'#e879f9',bg:'rgba(232,121,249,.10)'},
      target:'#9ca3af'
    };
    const def=(lbl,dat,col,ax)=>({type:'line',label:lbl,data:dat,yAxisID:ax,borderColor:col.border,backgroundColor:col.bg,tension:.35,fill:true,pointRadius:4,pointHoverRadius:5,borderWidth:2});
    const ds=[];
    PS2_FILTERS.forEach(f=>{ if(ps2State.active.has(f.key)) ds.push(def(f.label, ps2State.series[f.key], colors[f.key], f.axis)); });
    PS2_TARGETS.forEach(t=>{
      ds.push({type:'line',label:t.label,data:Array(LABELS_DO.length).fill(t.value),yAxisID:'y',borderColor:colors.target,borderDash:[6,6],borderWidth:2,pointRadius:0,fill:false});
    });
    return ds;
  }

  function drawPS2(inModal){
    const ctx=(inModal?document.getElementById('mcanvas'):document.getElementById('ps2')).getContext('2d');
    if(!inModal && chartPS2) chartPS2.destroy();
    if(inModal && window.__mchart) window.__mchart.destroy();

    const obj=new Chart(ctx,{
      type:'line',
      data:{labels:LABELS_DO,datasets:ps2Datasets()},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false,callbacks:{label:(c)=>` ${c.dataset.label}: ${c.dataset.yAxisID==='y'? c.parsed.y.toFixed(0)+'%': c.parsed.y.toLocaleString()} `}}},
        scales:{
          y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'},grid:{color:'rgba(156,163,175,.35)',borderDash:[4,4]}},
          y2:{position:'right',beginAtZero:true,grid:{drawOnChartArea:false},ticks:{callback:v=>v.toLocaleString()}},
          x:{ticks:{autoSkip:false,maxRotation:(window.innerWidth<640?90:0),minRotation:(window.innerWidth<640?90:0)}}
        }
      }
    });
    if(inModal) window.__mchart=obj; else chartPS2=obj;
  }

  async function loadPS2AndDraw(){
    try{ await loadPS2(); drawPS2(false); }catch(e){ console.error(e); document.getElementById('ps2err').textContent='Ralat memuat data.'; }
  }

  document.getElementById('ps2refresh').addEventListener('click', loadPS2AndDraw);
  document.getElementById('ps2expand').addEventListener('click', ()=>{
    document.getElementById('mtitle').textContent='Sekolah Rendah';
    const modal=document.getElementById('modal'); modal.classList.add('open');
    drawPS2(true);
    document.getElementById('mclose').onclick=()=>{ modal.classList.remove('open'); window.__mchart?.destroy(); };
  });

  // kick off tile2
  loadPS2AndDraw();

  </script>
</body>
</html>
