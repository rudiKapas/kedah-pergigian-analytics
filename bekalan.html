<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Stok Bekalan Inventori Pergigian Negeri Kedah</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="assets/icons/iconTab.svg">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=1">
  <script src="datasets.js?v=4"></script>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- page-level tweaks (same style approach as sekolah.html) -->
  <style>
    header.ph, .grid{ max-width:1200px; margin:0 auto; padding:0 20px; width:100%; }
    header.ph{ display:flex; flex-direction:column; align-items:stretch; text-align:left; padding-top:24px; }

    header.ph h1{ margin:0 0 4px; }
    header.ph p{ margin:0 0 16px; color:#5b6b83; }

    .ph .searchwrap{ position:relative; }
    .ph .searchbar{
      display:grid;
      grid-template-columns:44px 1fr;
      align-items:center;
      gap:12px;
    }

    .ph .btn-ghost{ height:44px; width:44px; border-radius:12px; background:#fff; color:#0f172a;
      border:1px solid #d8dee8; box-shadow:0 4px 14px rgba(15,27,45,.06); }
    .ph .btn-ghost:hover{ box-shadow:0 0 0 4px rgba(16,185,129,.15), 0 4px 14px rgba(15,27,45,.06); }
    .ph input[type="search"]{ height:44px; border-radius:12px; border:1px solid #e3e8f0; padding:0 16px;
      box-shadow:inset 0 4px 14px rgba(15,27,45,.06), 0 6px 18px rgba(15,27,45,.04); background:#fff; }
    #bekalanSearchRight{ height:44px; width:44px; border-radius:12px; background:#12a39a; color:#fff; border:0;
      box-shadow:0 4px 14px rgba(18,163,154,.25); }

    /* Autocomplete dropdown */
    .sugg-box{
      position:absolute; left:56px; right:56px; top:52px;
      background:#fff; border:1px solid #e3e8f0; border-radius:12px;
      box-shadow:0 18px 40px rgba(15,27,45,.14); z-index:1000; display:none;
      max-height:340px; overflow:auto;
    }
    .sugg-item{ padding:10px 12px; display:flex; gap:10px; align-items:center; cursor:pointer; }
    .sugg-item:hover, .sugg-item.active{ background:#f8fbff; }
    .sugg-type{ font-size:10px; font-weight:700; color:#0ea5e9; text-transform:uppercase; letter-spacing:.04em; }
    .sugg-label{ font-size:14px; color:#0f172a; }
    .sugg-empty{ padding:10px 12px; color:#64748b; font-size:13px; }

    .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:20px; margin-top:16px; }
    .tile.wide{ grid-column:1 / span 2; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } .tile.wide{ grid-column:1 / span 1; } }

    /* Row 1 container: behaves like normal grid on desktop, becomes a horizontal strip on mobile */
    .tile-strip{ display: contents; } /* desktop: children participate in the grid */
    
    @media (max-width: 900px){
      .tile-strip{
        display: flex;
        gap: 20px;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
        scrollbar-width: none;
        padding: 2px 0 10px;
      }
      .tile-strip::-webkit-scrollbar{ display:none; }
    
      .tile-strip .tile{
        flex: 0 0 calc(100vw - 40px);
        width: calc(100vw - 40px);
        margin-left: 20px;
        scroll-snap-align: center;
        box-sizing: border-box;
      }
      .tile-strip .tile:last-child{ margin-right: 20px; }
    
      /* wide tile should behave like a normal card in the strip */
      .tile-strip .tile.wide{
        grid-column: auto !important;
      }
    }


    .tile .chart{ height:440px; }
    .tile .chart canvas{ width:100% !important; height:100% !important; }

    /* ===== Bekalan only: 2nd-row mini tiles strip ===== */
    :root{
      --bekalan-mini: 260px; /* JS will override to 50% of the first tile height */
    }
    
    .bekalan-mini-row{
      grid-column: 1 / -1;
      margin-top: 14px;
    }
    
    .bekalan-mini-wrap{
      position: relative;
    }
    
    .bekalan-mini-strip{
      display:flex;
      width: 100%;
      max-width: 100%;
      min-width: 0;
      gap:16px;
      overflow-x:auto;
      padding: 2px 4px 8px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      touch-action: pan-x;
      overscroll-behavior-x: contain;
    }

    .bekalan-mini-row,
    .bekalan-mini-wrap{
      min-width: 0;
    }

    .bekalan-mini-strip::-webkit-scrollbar{ display:none; }
    
    .bekalan-mini-tile{
      flex: 0 0 var(--bekalan-mini);
      width: var(--bekalan-mini);
      min-width: var(--bekalan-mini);
      height: var(--bekalan-mini);
      aspect-ratio: 1 / 1;     /* square */
      border-radius:16px;
      border:1px solid #e5e7eb;
      background:#fff;
      box-shadow: 0 6px 18px rgba(15,27,45,.06);
      position:relative;
      overflow:hidden;
      scroll-snap-align: start;
      text-decoration:none;
      color:inherit;
    }
    
    .bekalan-mini-tile.is-image{
      background: url("assets/images/inventoryTile.png") center/cover no-repeat;
    }
    
    .bekalan-mini-tile:hover{
      box-shadow: 0 10px 28px rgba(2,6,23,.14);
      transform: translateY(-1px);
      transition: .15s ease;
    }
    
    .mini-badge{
      position:absolute;
      left:12px;
      bottom:12px;
      background: rgba(255,255,255,.92);
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:6px 10px;
      font-weight:800;
      font-size:11px;
      box-shadow:0 10px 22px rgba(15,23,42,.12);
    }

    /* Mini tile title (top-left): non-pill, larger, bold */
    .mini-title{
      position: absolute;
      left: 12px;
      top: 12px;
      font-size: 22px;
      font-weight: 600;
      color: #0f172a;
      line-height: 1.1;
      text-shadow: 0 10px 22px rgba(15,23,42,.18);
    }
    
    /* Allow the long bottom pill text to wrap cleanly */
    .mini-badge{
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: calc(100% - 24px);
    }


    /* Bekalan mini tile: top-left note + right liquid-glass stats */
    .mini-topnote{
      position:absolute;
      left:12px;
      top:12px;
      max-width: calc(100% - 24px);
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 800;
      color: #0f172a;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(227,232,240,.9);
      backdrop-filter: blur(6px);
    }
    
    .mini-glass{
      position:absolute;
      right:12px;
      top:50%;
      transform: translateY(-50%);
      width: min(210px, 62%);
      padding: 10px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.58);
      border: 1px solid rgba(227,232,240,.85);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(15,23,42,.14);
    }
    
    .mini-glass-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items:center;
      font-size: 11px;
      line-height: 1.2;
      color: #0f172a;
      padding: 3px 0;
    }
    
    .mini-glass-row b{
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }

    
    /* Desktop-only arrows */
    .bekalan-mini-arrow{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      height:44px;
      width:44px;
      border-radius:14px;
      border:1px solid #e5edf7;
      background: rgba(255,255,255,.92);
      box-shadow:0 14px 30px rgba(15,27,45,.18);
      display:none;                 /* hidden by default */
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index: 3;
    }
    
    .bekalan-mini-arrow svg{ width:18px; height:18px; }
    
    @media (min-width: 901px){
      .bekalan-mini-arrow{ display:flex; }
      /* add inner padding so arrows don't cover tiles */
      .bekalan-mini-strip{ padding-left: 60px; padding-right: 60px; }
      .bekalan-mini-arrow.left{ left: 12px; }
      .bekalan-mini-arrow.right{ right: 12px; }
      .bekalan-mini-arrow{ opacity: .5; }
      .bekalan-mini-arrow:hover{ opacity: 1; }
    }


    /* dropdown */
    .dd{ position:relative; }
    .dd .menu{
      position:absolute; right:0; top:44px;
      display:none; z-index:1000;
      width:360px; background:#fff;
      border:1px solid #e3e8f0; border-radius:12px;
      box-shadow:0 16px 36px rgba(15,27,45,.14);
      pointer-events:auto;
    }
    .dd.open .menu{ display:block; }
    .dd .menu .menu-body{ max-height:360px; overflow:auto; padding:8px 10px 4px; }
    .dd .menu .opt{ display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center;
      padding:8px 10px; border-radius:10px; }
    .dd .menu .opt:hover{ background:#f7fafc; }
    .dd .menu .mfoot{ display:flex; gap:8px; justify-content:flex-end; padding:10px; border-top:1px solid #ecf0f5; }
    .dd .menu .icbtn{ height:36px; width:36px; border:1px solid #e3e8f0; border-radius:8px; background:#fff; }
    .dd .menu .icbtn .ico{ height:20px; width:20px; }

    .sec-title{ font-size:12px; font-weight:800; color:#0f172a; margin:10px 6px 6px; }
    .sec-sub{ font-size:11px; color:#64748b; margin:-2px 6px 8px; }

    .tags{ display:flex; flex-wrap:wrap; gap:8px; margin:2px 0 6px; }
    .tag{ font-size:12px; font-weight:600; color:#0f172a; background:#edf7ff; border:1px solid #d9ecff;
      padding:4px 8px; border-radius:999px; }

    /* modal */
    .modal{ position:fixed; inset:0; display:none; background:rgba(13,23,41,.28); align-items:center; justify-content:center; z-index:9999; }
    .modal.open{ display:flex; }
    .modal-inner{ width:min(1100px, 96%); background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 24px 60px rgba(0,0,0,.28); }
    .mh{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; background:#f8fafc; border-bottom:1px solid #e7edf6; }
    .mb{ padding:16px 18px; }
    .mchart{ height:560px; }
    .mchart canvas{ width:100% !important; height:100% !important; }
    .close{ border:1px solid #d7dee9; background:#fff; height:34px; padding:0 10px; border-radius:8px; }

    /* legend */
    .legend{ display:flex; flex-wrap:wrap; gap:12px; margin-top:8px; }
    .legend .lg{ display:inline-flex; align-items:center; gap:8px; font-size:12px; font-weight:700; color:#334155; background:#f8fafc; border:1px solid #e5edf7; padding:5px 10px; border-radius:999px; }
    .legend .lg .dot{ height:10px; width:10px; border-radius:999px; display:inline-block; }

    .th .act .btn{ display:inline-flex; align-items:center; justify-content:center; height:44px; min-width:44px; border-radius:12px; border:1px solid #e5edf7; background:#fff; box-shadow:0 4px 14px rgba(15,27,45,.06); }
    .th .act .btn:hover{ box-shadow:0 0 0 4px rgba(59,130,246,.10), 0 4px 14px rgba(15,27,45,.06); }
    .th .ttl{ font-size:18px; margin:0; text-transform:uppercase; }
    .th .sub{ font-size:12px; color:#5b6b83; display:flex; align-items:center; gap:6px; }
    .th .ico{ width:18px; height:18px; }

    /* small label button (period selector) */
    .btn-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:0 12px;
      height:44px;
      border-radius:12px;
      border:1px solid #e5edf7;
      background:#fff;
      box-shadow:0 4px 14px rgba(15,27,45,.06);
      font-weight:800;
      color:#0f172a;
      cursor:pointer;
      user-select:none;
    }
    .btn-pill:hover{ box-shadow:0 0 0 4px rgba(59,130,246,.10), 0 4px 14px rgba(15,27,45,.06); }
    .btn-pill .mini{ font-size:12px; color:#64748b; font-weight:800; letter-spacing:.02em; }

    .err{ display:none; margin-top:10px; color:#b91c1c; font-weight:800; background:#fee2e2; border:1px solid #fecaca; padding:8px 10px; border-radius:10px; }


    @media (max-width: 900px){

      /* ---------- Header (match exact padding with grid) ---------- */
      header.ph{
        padding: 16px 14px 0 !important;   /* top, LR, bottom */
      }

      header.ph h1{
        font-size: 20px;
        line-height: 1.2;
        margin: 0 0 6px;
      }

      header.ph p{
        font-size: 13px;
        margin: 0 0 12px;
      }

      /* Fixed spacing */
      body{
        padding-top: 56px;
      }

      /* ---------- Search row: fill the same width as grid ---------- */
      .ph .searchwrap{ width: 100%; }

      .ph .searchbar{
        width: 100%;
        display: grid !important;
        grid-template-columns: 44px minmax(0, 1fr) !important;
        align-items: center;
        gap: 10px;
      }

      #bekalanSearchInput{
        width: 100%;
        min-width: 0;
      }

      /* Suggestions box aligned to input */
      .sugg-box{
        left: 56px;
        right: 0;
      }

    

      /* ============================================================
        MOBILE: INTERNAL TILE SCROLLING (TAGS & LEGEND)
        ============================================================ */
      
      /* Make Tags horizontally scrollable */
      #lbi-tile .tags {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        gap: 8px;
        padding-bottom: 6px;
        margin: 2px 0 10px;
        scrollbar-width: none;
      }
      #lbi-tile .tags::-webkit-scrollbar { display: none; }
      #lbi-tile .tag { flex: 0 0 auto; white-space: nowrap; }

      /* Make Legend horizontally scrollable */
      #lbi-tile .legend {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        gap: 12px;
        padding-bottom: 6px;
        margin-top: 10px;
        scrollbar-width: none;
      }
      #lbi-tile .legend::-webkit-scrollbar { display: none; }
      #lbi-tile .legend .lg { flex: 0 0 auto; white-space: nowrap; }

      /* Inner chart scroller (Data inside the tile) */
      #lbi-tile .chart-scroll{
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 10px;
        display: block;
      }

      #lbi-tile .chart-scroll .chart{
        display: block;
        width: 1000px !important;      /* Graph stays wide so districts aren't squashed */
        min-width: 1000px !important;
      }

      /* Charts height on mobile */
      .tile .chart{
        height: 320px;
      }

      /* Dropdown menus fit screen */
      .dd .menu{
        width: min(85vw, 360px);
      }

      /* Mobile fix: dropdown menus must not be clipped by the horizontal tile scroller */
      #lbi-tile .dd .menu{
        position: fixed !important;
        left: 14px !important;
        right: 14px !important;
        bottom: 14px !important;
        top: auto !important;

        width: auto !important;
        max-height: 70vh;
        z-index: 10000;
      }

      #lbi-tile .dd .menu .menu-body{
        max-height: calc(70vh - 56px);
      }


      /* MOBILE: LBI tile header restructure */
      #lbi-tile .th{
        height: auto !important;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
      }

      #lbi-tile .ttl{
        font-size: 14px;
        white-space: normal;
        line-height: 1.3;
      }

      /* Header actions horizontally scrollable */
      #lbi-tile .act{
        width: 100%;
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        gap: 8px;
        margin-top: 6px;
        padding-bottom: 4px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      #lbi-tile .act::-webkit-scrollbar { display: none; }
      #lbi-tile .act > * { flex: 0 0 auto; }

      #lbi-tile #lbiPeriodBtn{ width: auto; min-width: 120px; }
      #lbi-tile #lbiPeriodBtn .mini{ display: none; }
      
      /* Disable the body global horizontal overflow to keep swipe smooth */
      html, body{
        overflow-x: hidden;
      }
    }



  </style>

  <!-- icons -->
  <svg xmlns="http:///www.w3.org/2000/svg" style="display:none">
    <symbol id="i-time" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/>
    </symbol>
    <symbol id="i-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 12a9 9 0 1 1-3-6.7"/><path d="M21 3v6h-6"/>
    </symbol>
    <symbol id="i-expand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 9V4h5M4 4l6 6"/><path d="M20 15v5h-5M20 20l-6-6"/>
      <path d="M15 4h5v5M20 4l-6 6"/><path d="M9 20H4v-5M4 20l6-6"/>
    </symbol>
    <symbol id="i-filter" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 5h18l-7 8v6l-4-2v-4L3 5z"/>
    </symbol>
    <symbol id="i-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M18 6L6 18M6 6l12 12"/>
    </symbol>
    <symbol id="i-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/>
    </symbol>
  </svg>
</head>

<body>
  <header class="ph">
    <h1>Stok Bekalan Inventori Pergigian Negeri Kedah</h1>
    <p>Analitik ringkas untuk laporan stok, peruntukan dan perbelanjaan bekalan pergigian.</p>

    <div class="searchwrap">
      <div class="searchbar">
        <button id="bekalanSearchRight" title="Cari"><svg class="ico"><use href="#i-search"/></svg></button>
        <input id="bekalanSearchInput" type="search" placeholder="Cari tile, kategori atau metrik…" aria-label="Carian" autocomplete="off">
      </div>
      <div id="suggBox" class="sugg-box"></div>
    </div>
  </header>

  <main class="grid">
   <div class="tile-strip" id="bekalanMainStrip">
    <!-- TILE 1 (WIDE) -->
    <section class="tile wide" id="lbi-tile">
      <div class="th">
        <div>
          <h2 class="ttl">LAPORAN BULANAN INVENTORI (LBI) UBAT DAN BUKAN UBAT</h2>
          <div class="sub"><svg class="ico"><use href="#i-time"/></svg><span id="lbiTime">—</span></div>
        </div>

        <div class="act">

          <!-- FILTER (2-tier) -->
          <div class="dd" id="lbiFilterDD">
            <button class="btn dd-trigger" id="lbiFilterBtn" title="Tapis"><svg class="ico"><use href="#i-filter"/></svg></button>
            <div class="menu" id="lbiFilterMenu">
              <div class="menu-body" id="lbiFilterBody"></div>
              <div class="mfoot">
                <button class="icbtn" id="lbiAllCat" title="Pilih semua kategori" aria-label="Pilih semua kategori">
                  <img class="ico" src="assets/icons/selectAll.svg" alt="">
                </button>
                <button class="icbtn" id="lbiNoneCat" title="Kosongkan kategori" aria-label="Kosongkan kategori">
                  <img class="ico" src="assets/icons/unselectAll.svg" alt="">
                </button>
                <button class="icbtn" id="lbiCloseFilter" title="Tutup" aria-label="Tutup">
                  <svg class="ico"><use href="#i-x"/></svg>
                </button>
              </div>
            </div>
          </div>

          <button id="lbiRefresh" class="btn" title="Kemas Kini"><svg class="ico"><use href="#i-refresh"/></svg></button>
          <button id="lbiExpand"  class="btn" title="Perbesar"><svg class="ico"><use href="#i-expand"/></svg></button>
        </div>
      </div>

      <div class="tb">
        <div class="tags" id="lbiTags"></div>
        <div class="chart-scroll">
          <div class="chart"><canvas id="lbiChart"></canvas></div>
        </div>
        <div class="legend" id="lbiLegend"></div>
        <div class="err" id="lbiErr"></div>
      </div>
    </section>

  </div>


    <!-- ADDITIONAL TILES GO HERE (They will now swipe horizontally on mobile) -->
    <!-- ROW 2: Mini tiles strip (Bekalan only) -->
    <div class="bekalan-mini-row">
      <div class="bekalan-mini-wrap">
        <!-- Desktop arrows (hidden on mobile) -->
        <button class="bekalan-mini-arrow left" type="button" aria-label="Skrol kiri" id="bekalanMiniLeft">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
    
        <div class="bekalan-mini-strip" id="bekalanMiniStrip">
          <div class="bekalan-mini-tile is-image" role="group" aria-label="Kedah">
            <div class="mini-title">Kedah</div>
          
            <div class="mini-glass" aria-label="Anggaran stok boleh bertahan (bulan)">
              <div class="mini-glass-row"><span>Consumable bukan konsesi</span><b id="invCbnk">—</b></div>
              <div class="mini-glass-row"><span>Consumable konsesi</span><b id="invCk">—</b></div>
              <div class="mini-glass-row"><span>Reagent</span><b id="invReagent">—</b></div>
              <div class="mini-glass-row"><span>X-ray</span><b id="invXray">—</b></div>
            </div>
          
            <span class="mini-badge">Anggaran Stok Boleh bertahan (Bulan)</span>
          </div>


    

          <div class="bekalan-mini-tile" role="group" aria-label="Tile 2"><span class="mini-badge">Tile 2</span></div>
          <div class="bekalan-mini-tile" role="group" aria-label="Tile 3"><span class="mini-badge">Tile 3</span></div>
          <div class="bekalan-mini-tile" role="group" aria-label="Tile 4"><span class="mini-badge">Tile 4</span></div>
          <div class="bekalan-mini-tile" role="group" aria-label="Tile 5"><span class="mini-badge">Tile 5</span></div>
          <div class="bekalan-mini-tile" role="group" aria-label="Tile 6"><span class="mini-badge">Tile 6</span></div>
          <div class="bekalan-mini-tile" role="group" aria-label="Tile 7"><span class="mini-badge">Tile 7</span></div>
          <div class="bekalan-mini-tile" role="group" aria-label="Tile 8"><span class="mini-badge">Tile 8</span></div>
          <div class="bekalan-mini-tile" role="group" aria-label="Tile 9"><span class="mini-badge">Tile 9</span></div>

        </div>
    
        <button class="bekalan-mini-arrow right" type="button" aria-label="Skrol kanan" id="bekalanMiniRight">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
      </div>
    </div>


  </main>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-inner">
      <div class="mh">
        <h3 id="mtitle" style="margin:0;font-weight:800">—</h3>
        <button class="close" id="mclose">Tutup</button>
      </div>
      <div class="mb"><div class="mchart"><canvas id="mcanvas"></canvas></div></div>
    </div>
  </div>



  <script>window.__bSearch = window.__bSearch || { suggestions: [] };</script>


  <!-- TILE 1 LOGIC (LBI) -->
  <script>
  (function(){
    // =========================================================
    // 1) DATASET (CSV) CONFIG
    // =========================================================
  



    // =========================================================
    // 2) FILTER CONFIG (2-tier)
    // =========================================================
    const CATEGORIES = [
      { id:"reagent",     label:"Reagent",              color:"#0ea5e9" },
      { id:"konsesi",     label:"Consumable konsesi",   color:"#22c55e" },
      { id:"bukan",       label:"Consumable bukan konsesi", color:"#a78bfa" },
      { id:"xray",        label:"X-ray",                color:"#f59e0b" }
    ];

    const METRICS = [
      { id:"stok_perm",   label:"STOK PERMULAAN (RM)",                     col:"F", unit:"rm" },
      { id:"stok_diterima", label:"STOK DITERIMA PEROLEHAN SENDIRI (RM)",  col:"G", unit:"rm" },
      { id:"stok_keluar", label:"STOK DIKELUARKAN INTRA FASILITI (RM)",    col:"J", unit:"rm" },
      { id:"baki",        label:"BAKI STOK KESELURUHAN (RM)",              col:"L", unit:"rm" },
      { id:"tempoh",      label:"ANGGARAN TEMPOH BOLEH BERTAHAN (BULAN)",  col:"Q", unit:"bulan" },
      { id:"tambahan",    label:"KEPERLUAN PERUNTUKAN TAMBAHAN (RM)",      col:"R", unit:"rm" }
    ];

    // District group labels (based on your paired reporting structure)
    const AREAS = [
      { id:"ks_pendang", label:"Kota Setar & Pendang", rows:{ reagent:280, bukan:282, konsesi:287, xray:283 } },
      { id:"km_sik",     label:"Kuala Muda & Sik",     rows:{ reagent:313, bukan:315, konsesi:320, xray:316 } },
      { id:"kulim_bb",   label:"Kulim & Bandar Baru",  rows:{ reagent:302, bukan:304, konsesi:309, xray:305 } },
      { id:"kp",         label:"Kubang Pasu",          rows:{ reagent:291, bukan:293, konsesi:298, xray:294 } },
      { id:"pdg_terap",  label:"Pdg Terap",            rows:{ reagent:346, bukan:348, konsesi:353, xray:349 } },
      { id:"baling",     label:"Baling",               rows:{ reagent:324, bukan:326, konsesi:331, xray:327 } },
      { id:"yan",        label:"Yan",                  rows:{ reagent:357, bukan:359, konsesi:364, xray:360 } },
      { id:"langkawi",   label:"Langkawi",             rows:{ reagent:335, bukan:337, konsesi:342, xray:338 } },
      { id:"kedah",      label:"Kedah",                rows:{ reagent:38,  bukan:40,  konsesi:45,  xray:41  } }
    ];

    // =========================================================
    // 3) HELPERS (A1 -> table cell)
    // =========================================================
    function colIndex(A){
      let n=0;
      for(let i=0;i<A.length;i++) n = n*26 + (A.charCodeAt(i)-64);
      return n-1;
    }
    function getCell(table, A1){
      const m = /^([A-Z]+)(\d+)$/.exec(A1);
      if(!m) return null;
      const r = (+m[2]) - 1;
      const c = colIndex(m[1]);
      return (table[r] && table[r][c] != null) ? table[r][c] : null;
    }
    const toNum = v => {
      const s = String(v ?? "")
        .replace(/\u00A0/g,"")
        .replace(/[,\s]/g,"")
        .replace(/RM/gi,"")
        .replace(/%/g,"")
        .trim();
      const num = Number(s);
      return Number.isFinite(num) ? num : 0;
    };

    // =========================================================
    // 4) STATE
    // =========================================================
    let TABLE = null;

    function __colToIndex(colLetters){
      let n = 0;
      for(const ch of colLetters.toUpperCase()){
        n = n * 26 + (ch.charCodeAt(0) - 64);
      }
      return n - 1; // 0-based
    }
    
    function __getCell(table, ref){
      const m = /^([A-Z]+)(\d+)$/i.exec(String(ref).trim());
      if(!m) return null;
      const c = __colToIndex(m[1]);
      const r = parseInt(m[2], 10) - 1; // 0-based
      if(!table || !table[r] || typeof table[r][c] === "undefined") return null;
      const v = String(table[r][c]).trim();
      return v === "" ? null : v;
    }
    
    function updateMiniTileInventory(table){
      const set = (id, ref) => {
        const el = document.getElementById(id);
        if(!el) return;
        const v = __getCell(table, ref);
        el.textContent = (v == null) ? "—" : v;
      };
    
      // As requested (cell references from the same CSV as Tile 1)
      set("invCbnk", "Q40");    // Consumable bukan konsesi
      set("invCk",   "Q45");    // Consumable konsesi
      set("invReagent", "Q38"); // Reagent
      set("invXray", "Q41");    // X-ray
    }

    let chart = null;
    let selectedCats = new Set(CATEGORIES.map(x=>x.id));  // default: all categories shown
    let selectedMetric = "baki";                          // default: BAKI STOK


    function split2Lines(label){
      if(!label) return label;
      if(label.includes(" & ")){
        const [a,b] = label.split(" & ");
        return [a.trim(), "& " + b.trim()];
      }
      return label;
    }
    const PAD_LABELS = ()=> [' ', ...AREAS.map(a=>split2Lines(a.label)), ' '];

    // Filter (two-tier)
    const filterDD = document.getElementById('lbiFilterDD');
    const filterBody = document.getElementById('lbiFilterBody');

    function renderFilterMenu(){
      const catHTML = CATEGORIES.map(c=>{
        const checked = selectedCats.has(c.id) ? "checked" : "";
        return `<div class="opt" data-cat="${c.id}">
          <input type="checkbox" data-cat="${c.id}" ${checked}/>
          <span>${c.label}</span>
        </div>`;
      }).join('');

      const metHTML = METRICS.map(m=>{
        const checked = (m.id === selectedMetric) ? "checked" : "";
        return `<div class="opt" data-met="${m.id}">
          <input type="radio" name="lbiMetric" data-met="${m.id}" ${checked}/>
          <span>${m.label}</span>
        </div>`;
      }).join('');

      filterBody.innerHTML = `
        <div class="sec-title">Tier 1 — Kategori</div>
        <div class="sec-sub">Tunjuk/Sembunyi garisan mengikut kategori.</div>
        ${catHTML}
        <div class="sec-title" style="margin-top:14px;">Tier 2 — Metrik</div>
        <div class="sec-sub">Pilih metrik (paksi-Y) untuk diplot.</div>
        ${metHTML}
      `;
    }

    filterBody.addEventListener('change', (e)=>{
      const cb = e.target.closest('input[type="checkbox"][data-cat]');
      const rb = e.target.closest('input[type="radio"][data-met]');
      if(cb){
        if(cb.checked) selectedCats.add(cb.dataset.cat);
        else selectedCats.delete(cb.dataset.cat);
        syncTagsLegendAndVisibility();
      }
      if(rb){
        selectedMetric = rb.dataset.met;
        syncTagsLegendAndVisibility(true);
      }
    });

    filterBody.addEventListener('click', (e)=>{
      const rowCat = e.target.closest('.opt[data-cat]');
      if(rowCat){
        const input = rowCat.querySelector('input[type="checkbox"]');
        if(input && e.target !== input){
          input.checked = !input.checked;
          input.dispatchEvent(new Event('change',{bubbles:true}));
        }
      }
      const rowMet = e.target.closest('.opt[data-met]');
      if(rowMet){
        const input = rowMet.querySelector('input[type="radio"]');
        if(input && e.target !== input){
          input.checked = true;
          input.dispatchEvent(new Event('change',{bubbles:true}));
        }
      }
    });

    document.getElementById('lbiFilterBtn').addEventListener('click', (e)=>{ e.stopPropagation(); filterDD.classList.toggle('open'); });
    document.getElementById('lbiCloseFilter').addEventListener('click', ()=> filterDD.classList.remove('open'));
    document.addEventListener('click', (e)=>{ if(!filterDD.contains(e.target)) filterDD.classList.remove('open'); });

    document.getElementById('lbiAllCat').addEventListener('click', (e)=>{
      e.stopPropagation();
      selectedCats = new Set(CATEGORIES.map(x=>x.id));
      renderFilterMenu();
      syncTagsLegendAndVisibility();
    });
    document.getElementById('lbiNoneCat').addEventListener('click', (e)=>{
      e.stopPropagation();
      selectedCats = new Set();
      renderFilterMenu();
      syncTagsLegendAndVisibility();
    });

    // =========================================================
    // 6) CHART
    // =========================================================
    function gradientFill(ctx, hex){
      const g = ctx.createLinearGradient(0,0,0,360);
      const c = parseInt(hex.slice(1),16);
      const r=(c>>16)&255, gg=(c>>8)&255, b=c&255;
      const rgba = a=>`rgba(${r},${gg},${b},${a})`;
      g.addColorStop(0, rgba(.32));
      g.addColorStop(1, rgba(.03));
      return g;
    }

    function buildDatasets(ctx){
      const labels = PAD_LABELS();
      const met = METRICS.find(x=>x.id===selectedMetric) || METRICS[0];

      const last = labels.length - 1;
      const pointR = x => (x.dataIndex===0 || x.dataIndex===last ? 0 : 3);

      const ds = [];
      CATEGORIES.forEach(cat=>{
        const show = selectedCats.has(cat.id);
        const values = AREAS.map(a=>{
          const row = a.rows[cat.id];
          const col = met.col;
          const v = toNum(getCell(TABLE, col + String(row)));
          return v;
        });

        ds.push({
          _cat: cat.id,
          type: "line",
          label: cat.label,
          data: [0, ...values, 0],
          borderColor: cat.color,
          backgroundColor: gradientFill(ctx, cat.color),
          borderWidth: 3,
          tension: .45,
          fill: true,
          pointRadius: pointR,
          pointHoverRadius: 3,
          hidden: !show
        });
      });

      return ds;
    }

    function draw(){
      const err = document.getElementById('lbiErr');
      if(!TABLE){
        err.textContent = "Tiada data untuk diplot (TABLE kosong).";
        err.style.display = "block";
        return;
      }
      err.textContent = ""; err.style.display = "none";

      const ctx = document.getElementById('lbiChart').getContext('2d');
      if(chart) chart.destroy();

      const labels = PAD_LABELS();
      const met = METRICS.find(x=>x.id===selectedMetric) || METRICS[0];

      const isRM = met.unit === "rm";
      const isBulan = met.unit === "bulan";

      const isMobile = window.matchMedia('(max-width: 900px)').matches;


      chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: buildDatasets(ctx) },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          events: isMobile ? ['click'] : undefined,
          plugins: {
            legend: { display:false },
            tooltip: {
              mode: "index",
              intersect: false,
              callbacks: {
                label: (c)=>{
                  const v = c.parsed.y;
                  if(isRM) return `${c.dataset.label}: RM ${Number(v).toLocaleString()}`;
                  if(isBulan) return `${c.dataset.label}: ${Number(v).toLocaleString()} bulan`;
                  return `${c.dataset.label}: ${Number(v).toLocaleString()}`;
                }
              },
              filter: (i)=> !(i.dataIndex===0 || i.dataIndex===labels.length-1)
            }
          },
          scales: {
            x: { ticks:{ autoSkip:false, maxRotation:90, minRotation:90 } },
            y: {
              beginAtZero: true,
              ticks: {
                callback: (v)=>{
                  if(isRM) return `RM ${Number(v).toLocaleString()}`;
                  if(isBulan) return `${Number(v).toLocaleString()}`;
                  return Number(v).toLocaleString();
                }
              }
            }
          }
        }
      });

      document.getElementById('lbiTime').textContent = new Date().toLocaleString();
      setTimeout(adjustXAxisTicks, 0);
    }

    function adjustXAxisTicks(){
      if(!chart || !chart.options?.scales?.x?.ticks) return;
      const ticks = chart.options.scales.x.ticks;
      ticks.maxRotation = 90;
      ticks.minRotation = 90;
      ticks.autoSkip = false;
      chart.update();
    }

    let __rto=null;
    window.addEventListener('resize', ()=>{ clearTimeout(__rto); __rto=setTimeout(adjustXAxisTicks, 120); });

    // =========================================================
    // 7) TAGS + LEGEND + VISIBILITY
    // =========================================================
    function syncTagsLegendAndVisibility(rebuildChart=false){
      const tags = document.getElementById('lbiTags');
      const met = METRICS.find(x=>x.id===selectedMetric) || METRICS[0];
      const dsLabel = (window.__getSelectionLabels?.().period) || "—";
      const catsTxt = selectedCats.size
        ? Array.from(selectedCats).map(id=> CATEGORIES.find(x=>x.id===id)?.label).filter(Boolean)
        : [];


      

      tags.innerHTML = `
        <span class="tag">${dsLabel}</span>
        <span class="tag">${met.label}</span>
        ${catsTxt.length ? catsTxt.map(t=>`<span class="tag">${t}</span>`).join("") : `<span class="tag">Tiada kategori dipilih</span>`}
      `;

      // legend always shows chosen categories for interpretability
      const leg = document.getElementById('lbiLegend');
      leg.innerHTML = CATEGORIES
        .filter(c=> selectedCats.has(c.id))
        .map(c=>`<span class="lg"><span class="dot" style="background:${c.color}"></span>${c.label}</span>`)
        .join("");

      if(!chart || rebuildChart){
        draw();
        return;
      }

      chart.data.datasets.forEach(d=>{
        d.hidden = !selectedCats.has(d._cat);
      });
      chart.update();
    }

    // =========================================================
    // 8) DATA LOAD
    // =========================================================
    function loadAndDraw(){

      const url = __pickURL('bekalan','b1');

      const err = document.getElementById('lbiErr');
      if(!url){
        err.textContent = "Link CSV belum tersedia untuk tempoh ini.";
        err.style.display = "block";
        return;
      }

      Papa.parse(url, {
        download: true,
        skipEmptyLines: true,
        complete: (res)=>{
          TABLE = res.data;
          updateMiniTileInventory(TABLE);
          renderFilterMenu();
          syncTagsLegendAndVisibility(true);

          // smart search registration
          window.__bSearch.suggestions.push({type:"tile", tile:"lbi-tile", label:"LAPORAN BULANAN INVENTORI (LBI) UBAT DAN BUKAN UBAT"});
          CATEGORIES.forEach(c=> window.__bSearch.suggestions.push({type:"filter", tile:"lbi", key:c.id, label:c.label}));
          METRICS.forEach(m=> window.__bSearch.suggestions.push({type:"filter", tile:"lbi", key:m.id, label:m.label}));

        },
        error: ()=>{
          err.textContent = "Gagal memuatkan CSV (Tile LBI).";
          err.style.display = "block";
        }
      });
    }

    // expose apply for smart search
    window.__applyLBI = function(key){
      // If key matches category -> toggle only that category
      if(CATEGORIES.some(c=>c.id===key)){
        selectedCats = new Set([key]);
        renderFilterMenu();
        syncTagsLegendAndVisibility();
        document.getElementById('lbi-tile').scrollIntoView({behavior:'smooth', block:'start'});
        filterDD.classList.add('open');
        return;
      }
      // If key matches metric -> select metric
      if(METRICS.some(m=>m.id===key)){
        selectedMetric = key;
        renderFilterMenu();
        syncTagsLegendAndVisibility(true);
        document.getElementById('lbi-tile').scrollIntoView({behavior:'smooth', block:'start'});
        filterDD.classList.add('open');
        return;
      }

    };

    document.getElementById('lbiRefresh').addEventListener('click', loadAndDraw);

    document.getElementById('lbiExpand').addEventListener('click', ()=>{
      document.getElementById('mtitle').textContent = "LBI Ubat dan Bukan Ubat";
      const modal = document.getElementById('modal');
      modal.classList.add('open');

      const isMobile = window.matchMedia('(max-width: 900px)').matches;

      const mctx = document.getElementById('mcanvas').getContext('2d');
      window.__mchart?.destroy();
      window.__mchart = new Chart(mctx, {
        type:"line",
        data:{ labels: PAD_LABELS(), datasets: buildDatasets(mctx) },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{
            x:{ ticks:{ autoSkip:false, maxRotation:90, minRotation:90 } },
            y:{ beginAtZero:true }
          }
        }

      });
    });


    document.getElementById('mclose').addEventListener('click', ()=>{
      document.getElementById('modal').classList.remove('open');
      window.__mchart?.destroy();
    });


    // init

    renderFilterMenu();
    loadAndDraw();
  })();
  </script>



  <!-- SMART SEARCH (tiles + filters) -->
  <script>
    (function(){
      const box = document.getElementById('suggBox');
      const inp = document.getElementById('bekalanSearchInput');
      const btn = document.getElementById('bekalanSearchRight');

      function norm(s){ return (s||'').toLowerCase(); }
      function score(label, q){
        const L = norm(label), Q = norm(q);
        if(!Q) return 9999;
        const idx = L.indexOf(Q);
        if(idx === -1) return Infinity;
        const boundary = /\b/.test(L[idx-1] || ' ') ? 0 : 1;
        return boundary*100 + idx;
      }

      function render(items){
        if(!items.length){
          box.innerHTML = `<div class="sugg-empty">Tiada cadangan ditemui.</div>`;
          box.style.display = 'block';
          return;
        }
        box.innerHTML = items.map((it,i)=>`
          <div class="sugg-item" data-i="${i}">
            <div class="sugg-type">${it.type==='tile'?'Tile':'Filter'}</div>
            <div class="sugg-label">${it.label}</div>
          </div>
        `).join('');
        box.style.display = 'block';
      }

      function closeBox(){ box.style.display = 'none'; box.innerHTML = ''; }

      function allSuggestions(){
        const base = [{type:'tile', tile:'lbi-tile', label:'Stok Bekalan Inventori Pergigian Negeri Kedah'}];
        return base.concat(window.__bSearch.suggestions || []);
      }

      function search(q){
        const list = allSuggestions()
          .map(v => ({...v, _score:score(v.label, q)}))
          .filter(v => v._score !== Infinity)
          .sort((a,b)=> a._score - b._score)
          .slice(0, 12);

        render(list);
        Array.from(box.querySelectorAll('.sugg-item')).forEach((el, idx)=>{
          el.addEventListener('click', ()=> apply(list[idx]));
        });
      }

      function apply(item){
        closeBox();
        inp.blur();
        if(!item) return;

        if(item.type === 'tile'){
          document.getElementById(item.tile)?.scrollIntoView({behavior:'smooth', block:'start'});
          return;
        }
        if(item.type === 'filter'){
          // route filters to Tile 1 handler
          if(item.tile === 'lbi' && window.__applyLBI) window.__applyLBI(item.key);
        }
      }

      let activeIdx = -1;
      function highlight(i){
        const els = box.querySelectorAll('.sugg-item');
        els.forEach(el => el.classList.remove('active'));
        if(i>=0 && i<els.length){ els[i].classList.add('active'); activeIdx = i; }
      }

      inp.addEventListener('input', (e)=>{
        const q = e.target.value.trim();
        if(!q){ closeBox(); return; }
        search(q); activeIdx = -1;
      });

      inp.addEventListener('keydown', (e)=>{
        const els = box.querySelectorAll('.sugg-item');
        if(e.key==='ArrowDown'){
          if(els.length){ activeIdx=(activeIdx+1)%els.length; highlight(activeIdx); e.preventDefault(); }
        } else if(e.key==='ArrowUp'){
          if(els.length){ activeIdx=(activeIdx-1+els.length)%els.length; highlight(activeIdx); e.preventDefault(); }
        } else if(e.key==='Enter'){
          if(box.style.display==='block'){
            const q = inp.value.trim();
            const items = allSuggestions()
              .map(v => ({...v, _s:score(v.label, q)}))
              .filter(v => v._s !== Infinity)
              .sort((a,b)=> a._s - b._s)
              .slice(0, 12);
            apply(items[activeIdx>=0?activeIdx:0]);
            e.preventDefault();
          }
        } else if(e.key==='Escape'){ closeBox(); }
      });

      btn.addEventListener('click', ()=>{
        const q = inp.value.trim();
        if(!q){
          const list = allSuggestions().slice(0, 12);
          render(list);
          Array.from(box.querySelectorAll('.sugg-item')).forEach((el, idx)=>{
            el.addEventListener('click', ()=> apply(list[idx]));
          });
        } else {
          search(q);
        }
      });

      document.addEventListener('click', (e)=>{
        if(!box.contains(e.target) && e.target!==inp && e.target!==btn){ closeBox(); }
      });
    })();
  </script>

  <script>
  (function(){
    function setMiniSize(){
      const first = document.querySelector('#lbi-tile');
      if(!first) return;
  
      const h = Math.round(first.getBoundingClientRect().height * 0.5);
      const size = Math.max(220, Math.min(380, h)); // clamp for safety
      document.documentElement.style.setProperty('--bekalan-mini', size + 'px');
    }
  
    function bindMiniArrows(){
      const strip = document.getElementById('bekalanMiniStrip');
      const left = document.getElementById('bekalanMiniLeft');
      const right = document.getElementById('bekalanMiniRight');
      if(!strip || !left || !right) return;
  
      const step = () => Math.round(strip.clientWidth * 0.85);
  
      left.addEventListener('click', () => {
        strip.scrollBy({ left: -step(), behavior: 'smooth' });
      });
  
      right.addEventListener('click', () => {
        strip.scrollBy({ left: step(), behavior: 'smooth' });
      });
    }
  
    window.addEventListener('load', () => {
      setMiniSize();
      bindMiniArrows();
    });
  
    window.addEventListener('resize', () => {
      setMiniSize();
    });
  })();
  </script>






  <footer class="wrap">
    <div class="content">Analisa Kesihatan Pergigian Negeri Kedah • Paparan optimum disyorkan melalui pelayar web desktop</div>
  </footer>
</body>
</html>
